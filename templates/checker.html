<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Gateway Selector</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <h2>Bienvenido, {{ username }}</h2>

    <div>
        <button id="configBtn">Configuración</button>
        {% if role == 'owner' or role == 'admin' %}
            <button id="generateKeyBtn">Generar Key</button>
            <div id="generatedKeys" style="margin-top: 10px;"></div>
        {% endif %}
        {% if role == 'owner' %}
            <div style="margin-top: 20px;">
                <input type="text" id="newAdminUsername" placeholder="Usuario para Admin">
                <button id="addAdminBtn">Agregar Admin</button>
            </div>
        {% endif %}
    </div>

    <textarea id="ccs_input" placeholder="Pega aquí las CCs (una por línea)"></textarea><br>

    <div>
        <select id="gateway_select">
            <option value="TEC">TEC</option>
            <option value="RED">RED</option>
            <option value="EM">EM</option>
            <option value="AMAZON">AMAZON</option>
        </select><br>
        <div id="cookie_container" style="display: none; margin-top: 10px;">
            <textarea id="cookie_input" placeholder="Pega aquí tu Cookie de Amazon"></textarea><br>
            <button id="save_cookie">Guardar Cookie</button><br>
        </div>
        <button id="startBtn">Iniciar Gateway</button>
        <button id="stopBtn">Detener</button>
    </div>

    <div style="margin-top:20px;" id="configPanel" hidden>
        <input type="text" id="telegram_id_input" placeholder="Tu ID de Telegram">
        <button id="save_telegram_id_btn">Guardar ID</button>
        <br><br>
        <input type="text" id="redeem_key_input" placeholder="Canjear Nueva Key">
        <button id="redeem_key_btn">Canjear Key</button>
        <br><br>
        <button id="logoutBtn">Cerrar Sesión</button>
    </div>

    <div class="outputs-container">
        <div class="output live">
            <h3>LIVE</h3>
            <div id="live_output"></div>
        </div>
        <div class="output dead">
            <h3>DEAD</h3>
            <div id="dead_output"></div>
        </div>
        <div class="output funds">
            <h3>FONDOS INSUFICIENTES</h3>
            <div id="funds_output"></div>
        </div>
        <div class="output error">
            <h3>ERROR</h3>
            <div id="error_output"></div>
        </div>
    </div>

    <!-- Modal para seleccionar duración de Key -->
    <div id="keyModal" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 20px; border-radius: 10px; text-align: center;">
            <h3>Selecciona la duración de la Key</h3>
            <select id="keyDurationSelect">
                <option value="1">1 Día</option>
                <option value="7">7 Días</option>
                <option value="15">15 Días</option>
                <option value="30">30 Días</option>
            </select><br><br>
            <button id="confirmGenerateKey">Generar</button>
            <button onclick="document.getElementById('keyModal').style.display='none'">Cancelar</button>
        </div>
    </div>

    <script>
        let isRunning = false;
        let amazonCookie = "";

        document.getElementById('configBtn').addEventListener('click', () => {
            document.getElementById('configPanel').hidden = !document.getElementById('configPanel').hidden;
        });

        document.getElementById('save_telegram_id_btn').addEventListener('click', async () => {
            const telegramId = document.getElementById('telegram_id_input').value.trim();
            if (!telegramId) return alert('Ingresa tu ID de Telegram');
            const res = await fetch('/save_telegram_id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: telegramId })
            });
            const data = await res.json();
            alert(data.message);
        });

        document.getElementById('redeem_key_btn').addEventListener('click', async () => {
            const keyInput = document.getElementById('redeem_key_input').value.trim();
            if (!keyInput) return alert('Ingresa una key válida.');
            const res = await fetch('/redeem_key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: keyInput })
            });
            const data = await res.json();
            alert(data.message);
            if (data.status === 'success') location.reload();
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            window.location.href = '/logout';
        });

        document.getElementById('gateway_select').addEventListener('change', () => {
            const gateway = document.getElementById('gateway_select').value;
            document.getElementById('cookie_container').style.display = (gateway === 'AMAZON') ? 'block' : 'none';
        });

        document.getElementById('save_cookie').addEventListener('click', () => {
            const cookieValue = document.getElementById('cookie_input').value.trim();
            if (!cookieValue) return alert('⚠️ Pega tu cookie.');
            amazonCookie = cookieValue;
            alert('✅ Cookie guardada localmente.');
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            const ccsInput = document.getElementById('ccs_input').value.trim();
            if (ccsInput === '') return alert('⚠️ Proporciona algunas CCs para comenzar.');
            if (document.getElementById('gateway_select').value === 'AMAZON' && !amazonCookie) {
                return alert('⚠️ Debes guardar la cookie de Amazon antes de continuar.');
            }
            if (isRunning) return;
            isRunning = true;
            startChecking();
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            isRunning = false;
        });

        async function startChecking() {
            const ccs = document.getElementById('ccs_input').value.trim().split('\n').filter(cc => cc.trim() !== '');
            const gateway = document.getElementById('gateway_select').value;
            const liveOutput = document.getElementById('live_output');
            const deadOutput = document.getElementById('dead_output');
            const fundsOutput = document.getElementById('funds_output');
            const errorOutput = document.getElementById('error_output');

            liveOutput.innerHTML = '';
            deadOutput.innerHTML = '';
            fundsOutput.innerHTML = '';
            errorOutput.innerHTML = '';

            for (let i = 0; i < ccs.length; i++) {
                if (!isRunning) break;
                const cc = ccs[i].trim();

                const result = await checkGateway(cc, gateway);

                if (result.status === 'live') {
                    liveOutput.innerHTML += `<div><strong>${result.cc}</strong></div>`;
                } else if (result.status === 'dead') {
                    deadOutput.innerHTML += `<div><strong>${result.cc}</strong></div>`;
                } else if (result.status === 'insufficient_funds') {
                    fundsOutput.innerHTML += `<div><strong>${result.cc}</strong></div>`;
                } else {
                    errorOutput.innerHTML += `<div><strong>${result.cc}</strong> - ${result.message}</div>`;
                }

                await sleep(500);
            }

            isRunning = false;
            alert('✅ Proceso finalizado');
        }

        async function checkGateway(cc, gateway) {
            try {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cc: cc, gateway: gateway, cookie: amazonCookie })
                });

                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return { status: 'error', message: `Respuesta no JSON del servidor: ${text}`, cc: cc };
                }
            } catch (err) {
                return { status: 'error', message: `Error de conexión: ${err.message}`, cc: cc };
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        {% if role == 'owner' or role == 'admin' %}
        document.getElementById('generateKeyBtn').addEventListener('click', () => {
            document.getElementById('keyModal').style.display = 'flex';
        });

        document.getElementById('confirmGenerateKey').addEventListener('click', async () => {
            const days = document.getElementById('keyDurationSelect').value;
            const res = await fetch('/generate_key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration_days: days })
            });
            const data = await res.json();
            if (data.status === 'success') {
                const keysDiv = document.getElementById('generatedKeys');
                keysDiv.innerHTML += `<div>${data.key} (Expira: ${data.expires_at.split('T')[0]})</div>`;
            } else {
                alert(data.message);
            }
            document.getElementById('keyModal').style.display = 'none';
        });
        {% endif %}

        {% if role == 'owner' %}
        document.getElementById('addAdminBtn').addEventListener('click', async () => {
            const username = document.getElementById('newAdminUsername').value.trim();
            if (!username) return alert('Ingresa el nombre de usuario');
            const res = await fetch('/add_admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username })
            });
            const data = await res.json();
            alert(data.message);
        });
        {% endif %}
    </script>

</body>
</html>
