<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Gateway Selector</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<h2>Bienvenido, {{ username }}</h2>

<div>
    <button id="configBtn">Configuración</button>
    {% if role == 'owner' or role == 'admin' %}
    <button id="generateKeyBtn">Generar Key</button>
    <div id="generatedKeys"></div>
    {% endif %}
    {% if role == 'owner' %}
    <div style="margin-top: 20px;">
        <input type="text" id="newAdminUsername" placeholder="Usuario para Admin">
        <button id="addAdminBtn">Agregar Admin</button>
    </div>
    {% endif %}
</div>

<textarea id="ccs_input" placeholder="Pega aquí las CCs (una por línea)"></textarea><br>

<div>
    <select id="gateway_select">
        <option value="TEC">TEC</option>
        <option value="RED">RED</option>
        <option value="EM">EM</option>
        <option value="AMAZON">AMAZON</option>
    </select><br>
    <div id="cookie_container" style="display: none; margin-top: 10px;">
        <textarea id="cookie_input" placeholder="Pega aquí tu Cookie de Amazon"></textarea><br>
        <button id="save_cookie">Guardar Cookie</button><br>
    </div>
    <button id="startBtn">Iniciar Gateway</button>
    <button id="stopBtn">Detener</button>
</div>

<div style="margin-top:20px;" id="configPanel" hidden>
    <input type="text" id="telegram_id_input" placeholder="Tu ID de Telegram">
    <button id="save_telegram_id_btn">Guardar ID</button>
    <button id="logoutBtn">Cerrar Sesión</button>
</div>

<div class="outputs-container">
    <div class="output live"><h3>LIVE</h3><div id="live_output"></div></div>
    <div class="output dead"><h3>DEAD</h3><div id="dead_output"></div></div>
    <div class="output funds"><h3>FONDOS INSUFICIENTES</h3><div id="funds_output"></div></div>
    <div class="output error"><h3>ERROR</h3><div id="error_output"></div></div>
</div>

<script>
    let isRunning = false;
    let amazonCookie = "";

    document.getElementById('configBtn').addEventListener('click', () => {
        document.getElementById('configPanel').hidden = !document.getElementById('configPanel').hidden;
    });

    document.getElementById('save_telegram_id_btn').addEventListener('click', async () => {
        const telegramId = document.getElementById('telegram_id_input').value.trim();
        if (!telegramId) return alert('Ingresa tu ID de Telegram');
        const res = await fetch('/save_telegram_id', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telegram_id: telegramId })
        });
        const data = await res.json();
        alert(data.message);
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        window.location.href = '/logout';
    });

    {% if role == 'owner' or role == 'admin' %}
    document.getElementById('generateKeyBtn').addEventListener('click', async () => {
        const res = await fetch('/generate_key', { method: 'POST' });
        const data = await res.json();
        if (data.status === 'success') {
            const keysDiv = document.getElementById('generatedKeys');
            keysDiv.innerHTML += `<div>${data.key}</div>`;
        } else {
            alert(data.message);
        }
    });
    {% endif %}

    {% if role == 'owner' %}
    document.getElementById('addAdminBtn').addEventListener('click', async () => {
        const username = document.getElementById('newAdminUsername').value.trim();
        if (!username) return alert('Ingresa el nombre de usuario');
        const res = await fetch('/add_admin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username })
        });
        const data = await res.json();
        alert(data.message);
    });
    {% endif %}
</script>

</body>
</html>
