<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Gateway Selector</title>
    <style>
        body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 10px;
    background: #f5f5f5;
}

/* Título centrado */
h2 {
    text-align: center;
    margin-bottom: 15px;
}

/* Contenedor principal */
.container {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
}

/* Panel izquierdo */
.left-panel {
    width: 320px;
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex-shrink: 0;
}

/* Panel central */
.center-panel {
    flex: 1;
    min-width: 300px;
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Textarea CCs */
#ccs_input {
    width: 100%;
    min-height: 120px;
    resize: vertical;
    font-family: monospace;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

/* Botones y selects */
button, select, input[type=text], textarea {
    width: 100%;
    margin-bottom: 8px;
    box-sizing: border-box;
}

button {
    cursor: pointer;
    padding: 8px;
    border-radius: 5px;
    border: none;
    background-color: #007bff;
    color: white;
    font-size: 14px;
}
button:hover { background-color: #0056b3; }

/* Contenedor outputs */
.outputs-container {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
    justify-content: space-between;
}

/* Cada output flexible y con scroll */
.output {
    flex: 1 1 45%;
    background: #f9f9f9;
    border-radius: 6px;
    padding: 10px;
    max-height: 200px;
    overflow-y: auto;
}

/* Encabezado de output */
.output h3 {
    margin-top: 0;
    margin-bottom: 8px;
    font-size: 16px;
    border-bottom: 2px solid #007bff;
    padding-bottom: 3px;
}

/* Barra de progreso */
#progressContainer {
    width: 100%;
    background-color: #ddd;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 10px;
    height: 22px;
    display: none;
}
#progressBar {
    height: 100%;
    width: 0%;
    background-color: #007bff;
    text-align: center;
    color: white;
    font-weight: bold;
    line-height: 22px;
    user-select: none;
}

/* Ajustes móviles */
@media (max-width: 768px) {
    .container {
        flex-direction: column;
        gap: 10px;
    }
    .left-panel {
        width: 100%;
        order: 2; /* Panel izquierdo debajo */
    }
    .center-panel {
        width: 100%;
        order: 1; /* Panel central arriba */
    }
    .outputs-container {
        flex-direction: column;
        gap: 10px;
    }
    .output {
        flex: 1 1 100%;
        max-height: none;
        min-height: 120px;
    }
    #ccs_input {
        min-height: 100px;
    }
}

    </style>
</head>
<body>

    <h2>Bienvenido, {{ username }}</h2>

    <div class="container">

        <!-- Columna izquierda: configuración y controles -->
        <div class="left-panel">
            <button id="configBtn">Configuración</button>
            {% if role == 'owner' or role == 'admin' %}
                <button id="generateKeyBtn">Generar Key</button>
                <div id="generatedKeys" style="margin-top: 10px;"></div>
            {% endif %}
            {% if role == 'owner' %}
                <div>
                    <input type="text" id="newAdminUsername" placeholder="Usuario para Admin">
                    <button id="addAdminBtn">Agregar Admin</button>
                </div>
            {% endif %}

            <div id="configPanel" hidden>
                <input id="telegram_id_input" type="text" placeholder="Tu Telegram ID" />
                <button id="start_verification_btn">Enviar código de verificación</button>

                <input id="verification_code_input" type="text" placeholder="Ingresa código recibido" />
                <button id="confirm_code_btn">Confirmar código</button>

                <input type="text" id="redeem_key_input" placeholder="Canjear Nueva Key" style="margin-top:15px;">
                <button id="redeem_key_btn">Canjear Key</button>

                <button id="logoutBtn" style="margin-top:20px; background:#dc3545;">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Columna central: CCs, selección gateway y resultados -->
        <div class="center-panel">

            <textarea id="ccs_input" placeholder="Pega aquí las CCs (una por línea)"></textarea>

            <select id="gateway_select">
                <option value="TEC">TEC ccs</option>
                <option value="RED">RED</option>
                <option value="EM">EM</option>
                <option value="PAY">PAY</option>
                <option value="UL">UL</UL></option>
                <option value="AMAZON">AMAZON</option>
            </select>

            <div id="cookie_container" style="display: none;">
                <textarea id="cookie_input" placeholder="Pega aquí tu Cookie de Amazon"></textarea>
                <button id="save_cookie">Guardar Cookie</button>
            </div>

            <!-- Barra de progreso -->
            <div id="progressContainer">
                <div id="progressBar">0%</div>
            </div>

            <div style="margin-top: 15px;">
                <button id="startBtn">Iniciar Gateway</button>
                <button id="stopBtn" style="background:#dc3545;">Detener</button>
            </div>

            <div class="outputs-container">
                <div class="output live">
                    <h3>LIVE</h3>
                    <div id="live_output"></div>
                </div>
                <div class="output dead">
                    <h3>DEAD</h3>
                    <div id="dead_output"></div>
                </div>
                <div class="output funds">
                    <h3>FONDOS INSUFICIENTES</h3>
                    <div id="funds_output"></div>
                </div>
                <div class="output error">
                    <h3>ERROR</h3>
                    <div id="error_output"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal para seleccionar duración de Key -->
    <div id="keyModal">
        <div>
            <h3>Selecciona la duración de la Key</h3>
            <select id="keyDurationSelect">
                <option value="1">1 Día</option>
                <option value="7">7 Días</option>
                <option value="15">15 Días</option>
                <option value="30">30 Días</option>
            </select><br><br>
            <button id="confirmGenerateKey">Generar</button>
            <button onclick="document.getElementById('keyModal').style.display='none'">Cancelar</button>
        </div>
    </div>

<script>
    let isRunning = false;
    let amazonCookie = "";

    document.getElementById('configBtn').addEventListener('click', () => {
        document.getElementById('configPanel').hidden = !document.getElementById('configPanel').hidden;
    });

    document.getElementById('start_verification_btn').addEventListener('click', async () => {
    const telegramId = document.getElementById('telegram_id_input').value.trim();
    if (!telegramId) return alert('Ingresa tu ID de Telegram');

        // Primero intentamos guardar el Telegram ID sin forzar
        let res = await fetch('/save_telegram_id', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ telegram_id: telegramId })
        });
        let data = await res.json();

        if (data.status === 'confirm') {
            // Si hay que confirmar reemplazo, preguntamos al usuario
            const confirmar = confirm(data.message + "\n¿Deseas reemplazarlo?");
            if (confirmar) {
                // Si confirma, enviamos la petición con force=true
                res = await fetch('/save_telegram_id', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ telegram_id: telegramId, force: true })
                });
                data = await res.json();
                alert(data.message);
            }
        } else {
            // Si no hay confirmación pendiente, mostrar mensaje directo
            alert(data.message);
        }
    });


    document.getElementById('confirm_code_btn').addEventListener('click', async () => {
        const telegramId = document.getElementById('telegram_id_input').value.trim();
        const code = document.getElementById('verification_code_input').value.trim();
        if (!telegramId || !code) return alert('Ingresa tu ID de Telegram y el código de verificación');

        const res = await fetch('/confirm_telegram_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({telegram_id: telegramId, code: code})
        });
        const data = await res.json();
        alert(data.message);
    });

    document.getElementById('redeem_key_btn').addEventListener('click', async () => {
        const keyInput = document.getElementById('redeem_key_input').value.trim();
        if (!keyInput) return alert('Ingresa una key válida.');
        const res = await fetch('/redeem_key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: keyInput })
        });
        const data = await res.json();
        alert(data.message);
        if (data.status === 'success') location.reload();
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        window.location.href = '/logout';
    });

    document.getElementById('gateway_select').addEventListener('change', () => {
        const gateway = document.getElementById('gateway_select').value;
        document.getElementById('cookie_container').style.display = (gateway === 'AMAZON') ? 'block' : 'none';
    });

    document.getElementById('save_cookie').addEventListener('click', () => {
        const cookieValue = document.getElementById('cookie_input').value.trim();
        if (!cookieValue) return alert('⚠️ Pega tu cookie.');
        amazonCookie = cookieValue;
        alert('✅ Cookie guardada localmente.');
    });

    document.getElementById('startBtn').addEventListener('click', () => {
        const ccsInput = document.getElementById('ccs_input').value.trim();
        if (ccsInput === '') return alert('⚠️ Proporciona algunas CCs para comenzar.');
        if (document.getElementById('gateway_select').value === 'AMAZON' && !amazonCookie) {
            return alert('⚠️ Debes guardar la cookie de Amazon antes de continuar.');
        }
        if (isRunning) return;
        isRunning = true;
        startChecking();
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        isRunning = false;
    });

    function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function startChecking() {
        const ccs = document.getElementById('ccs_input').value.trim().split('\n').filter(cc => cc.trim() !== '');
        const gateway = document.getElementById('gateway_select').value;
        const liveOutput = document.getElementById('live_output');
        const deadOutput = document.getElementById('dead_output');
        const fundsOutput = document.getElementById('funds_output');
        const errorOutput = document.getElementById('error_output');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        liveOutput.innerHTML = '';
        deadOutput.innerHTML = '';
        fundsOutput.innerHTML = '';
        errorOutput.innerHTML = '';

        // Mostrar barra de progreso y resetear
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        for (let i = 0; i < ccs.length; i++) {
            if (!isRunning) break;
            const cc = ccs[i].trim();

            const result = await checkGateway(cc, gateway);

            if (result.status === 'live') {
                liveOutput.innerHTML += `<div><strong>${result.cc}</strong></div>`;
            } else if (result.status === 'dead') {
                deadOutput.innerHTML += `<div><strong>${result.cc}</strong></div>`;
            } else if (result.status === 'insufficient_funds') {
                fundsOutput.innerHTML += `<div><strong>${result.cc}</strong></div>`;
            } else {
                errorOutput.innerHTML += `<div><strong>${result.cc}</strong> - ${result.message}</div>`;
            }

            // Actualizar barra de progreso
            const progressPercent = Math.round(((i + 1) / ccs.length) * 100);
            progressBar.style.width = progressPercent + '%';
            progressBar.textContent = progressPercent + '%';

            // Delay de 10 segundos entre cada CC (solo si no es la última)
            if (i < ccs.length - 1) {
                await sleep(10000);
            }
        }

        isRunning = false;
        progressBar.textContent = '✅ Proceso finalizado';
    }


    async function checkGateway(cc, gateway) {
        try {
            const response = await fetch('/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cc: cc, gateway: gateway, cookie: amazonCookie })
            });

            const text = await response.text();
            try {
                return JSON.parse(text);
            } catch (e) {
                return { status: 'error', message: `Respuesta no JSON del servidor: ${text}`, cc: cc };
            }
        } catch (err) {
            return { status: 'error', message: `Error de conexión: ${err.message}`, cc: cc };
        }
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    {% if role == 'owner' or role == 'admin' %}
    document.getElementById('generateKeyBtn').addEventListener('click', () => {
        document.getElementById('keyModal').style.display = 'flex';
    });

    document.getElementById('confirmGenerateKey').addEventListener('click', async () => {
        const days = document.getElementById('keyDurationSelect').value;
        const res = await fetch('/generate_key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ duration_days: days })
        });
        const data = await res.json();
        if (data.status === 'success') {
            const keysDiv = document.getElementById('generatedKeys');
            keysDiv.innerHTML += `<div>${data.key} (Expira: ${data.expires_at.split('T')[0]})</div>`;
        } else {


                alert(data.message);
            }
            document.getElementById('keyModal').style.display = 'none';
        });
        {% endif %}

        {% if role == 'owner' %}
        document.getElementById('addAdminBtn').addEventListener('click', async () => {
            const username = document.getElementById('newAdminUsername').value.trim();
            if (!username) return alert('Ingresa el nombre de usuario');
            const res = await fetch('/add_admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username })
            });
            const data = await res.json();
            alert(data.message);
        });
        {% endif %}
    </script>

</body>
</html>



